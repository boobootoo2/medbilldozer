name: Warmup HuggingFace Endpoint

on:
  # Run 1 hour before clinical validation (11pm UTC, validation at 12am UTC)
  schedule:
    - cron: '0 23 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  warmup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Wake up HuggingFace endpoint
        env:
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
          HF_ENDPOINT_BASE: ${{ secrets.HF_ENDPOINT_BASE }}
          HF_MODEL_ID: google/medgemma-4b-it
        run: |
          echo "üî• Warming up HuggingFace Inference Endpoint..."
          echo "‚è∞ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üìç Endpoint: ${HF_ENDPOINT_BASE}"
          
          # Send multiple warmup requests to ensure endpoint is loaded
          echo ""
          echo "üöÄ Sending warmup requests..."
          
          for i in {1..5}; do
            echo "  Request $i/5..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${HF_ENDPOINT_BASE}/v1/chat/completions" \
              -H "Authorization: Bearer ${HF_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d '{
                "model": "google/medgemma-4b-it",
                "messages": [{"role": "user", "content": "Hello"}],
                "max_tokens": 10,
                "temperature": 0.0
              }')
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  ‚úÖ Success (HTTP $HTTP_CODE)"
            else
              echo "  ‚ö†Ô∏è  HTTP $HTTP_CODE - Endpoint may be initializing..."
            fi
            
            # Wait between requests
            if [ $i -lt 5 ]; then
              sleep 30
            fi
          done
          
          echo ""
          echo "üîç Final verification..."
          
          # Final check
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${HF_ENDPOINT_BASE}/v1/chat/completions" \
            -H "Authorization: Bearer ${HF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "google/medgemma-4b-it",
              "messages": [{"role": "user", "content": "Test"}],
              "max_tokens": 50,
              "temperature": 0.0
            }')
          
          echo ""
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Endpoint is ready and warm!"
            echo "üïê Benchmark workflow will start in ~50 minutes"
          else
            echo "‚ö†Ô∏è  Endpoint status: HTTP $STATUS"
            echo "   The endpoint may still be initializing."
            echo "   It should be ready by the time benchmarks start."
          fi
          
          echo ""
          echo "üìä Summary:"
          echo "  - Warmup completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Benchmark scheduled for: 2:00 AM UTC"
          echo "  - Time until benchmarks: ~$(( 60 - $(date +%M) )) minutes"
