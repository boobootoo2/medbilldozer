name: Run Benchmarks

on:
  # Run on schedule (daily at 2am UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # Run manually
  workflow_dispatch:
  
  # Run on pushes to develop
  push:
    branches:
      - develop
    paths:
      - 'src/medbilldozer/providers/**'
      - 'src/medbilldozer/extractors/**'
      - 'scripts/generate_patient_benchmarks.py'
      - 'benchmarks/inputs/**'
      - 'benchmarks/patient_profiles/**'
      - '.github/workflows/run_benchmarks.yml'

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow workflow to push commits
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Use built-in token for auth
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install main dependencies first (required for medbilldozer package)
          pip install -r requirements.txt
          # Install package in editable mode (provides medbilldozer imports)
          pip install -e . -v
          # Install benchmark-specific requirements (may override some versions)
          pip install -r requirements-benchmarks.txt
          # Verify installation
          python -c "import sys; print('Python path:', sys.path); import medbilldozer; print(f'medbilldozer {medbilldozer.__version__} imported successfully from {medbilldozer.__file__}')"
      
      - name: Run benchmarks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
          HF_ENDPOINT_BASE: ${{ secrets.HF_ENDPOINT_BASE }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          # Run patient benchmarks for all models using v2 script with parallel workers
          python3 scripts/run_benchmarks_v2.py --model all --workers 2 
      
      - name: Convert results to monitoring format
        if: always()
        run: |
          mkdir -p benchmark-artifacts
          # Convert each model's patient benchmark results (61 patients)
          # Only convert models that were actually run
          for model in openai; do
            if [ -f "benchmarks/results/patient_benchmark_${model}.json" ]; then
              python3 scripts/convert_benchmark_to_monitoring.py \
                --input "benchmarks/results/patient_benchmark_${model}.json" \
                --output "benchmark-artifacts/${model}_benchmark_results.json" \
                --model "${model}"
            fi
          done
      
      - name: Calculate ROI and cost savings
        if: always()
        run: |
          # Calculate ROI metrics for all models
          python3 scripts/calculate_roi_metrics.py \
            --results-dir benchmark-artifacts \
            --output benchmark-artifacts/roi_summary.json \
            --report benchmark-artifacts/roi_report.md
      
      - name: Push results to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Push each model's patient benchmark results (61 patients) to Supabase
          # Only push models that were actually run
          for model in openai; do
            if [ -f "benchmark-artifacts/${model}_benchmark_results.json" ]; then
              echo "ðŸ“¤ Pushing ${model} results to Supabase..."
              python3 scripts/push_to_supabase.py \
                --input "benchmark-artifacts/${model}_benchmark_results.json" \
                --environment github-actions \
                --commit-sha ${{ github.sha }} \
                --branch-name ${{ github.ref_name }} \
                --run-id ${{ github.run_id }} \
                --triggered-by ${{ github.actor }} \
                --verify || echo "âš ï¸ Failed to push ${model} to Supabase"
            fi
          done
      
      - name: Display ROI summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ’° ROI & COST SAVINGS SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat benchmark-artifacts/roi_report.md
      
      - name: Upload benchmark results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-artifacts/*.json
            benchmark-artifacts/*.md
          retention-days: 90
      
      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // Load ROI summary
            let roiData;
            try {
              roiData = JSON.parse(fs.readFileSync('benchmark-artifacts/roi_summary.json', 'utf8'));
            } catch (error) {
              console.log('ROI data not found, skipping PR comment');
              return;
            }
            
            // Build comment with ROI metrics
            let comment = '## ï¿½ Benchmark Results: ROI & Cost Savings\n\n';
            
            // Executive summary
            const summary = roiData.summary;
            comment += '### Executive Summary\n\n';
            comment += `- **Total Consumer Savings**: $${summary.total_potential_savings.toLocaleString()}\n`;
            comment += `- **Total Analysis Cost**: $${summary.total_cost.toFixed(2)}\n`;
            comment += `- **Net Benefit**: $${summary.total_net_benefit.toLocaleString()}\n`;
            comment += `- **Overall ROI**: ${(summary.total_potential_savings / summary.total_cost).toFixed(1)}x\n\n`;
            
            // Model comparison table
            comment += '### Model Performance & ROI\n\n';
            comment += '| Model | Savings | Cost | Net Benefit | ROI | F1 |\n';
            comment += '|-------|---------|------|-------------|-----|----|\n';
            
            // Sort by ROI
            const sortedResults = roiData.model_results.sort((a, b) => 
              b.roi_metrics.roi_ratio - a.roi_metrics.roi_ratio
            );
            
            for (const result of sortedResults) {
              const savings = result.consumer_savings.total_potential_savings;
              const cost = result.cost_breakdown.total_cost;
              const net = result.roi_metrics.net_benefit;
              const roi = result.roi_metrics.roi_ratio;
              const f1 = result.performance_metrics.f1;
              
              comment += `| ${result.model_name} | $${savings.toLocaleString()} | $${cost.toFixed(2)} | $${net.toLocaleString()} | ${roi.toFixed(1)}x | ${f1.toFixed(3)} |\n`;
            }
            
            comment += '\nðŸ“Š [View detailed report â†’](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
